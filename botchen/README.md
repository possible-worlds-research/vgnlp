# VGNLP Botchen

VGNLP Botchen extracts and formats data from the [Visual Genome](https://homes.cs.washington.edu/~ranjay/visualgenome/index.html) dataset to train and evaluate a tiny chatbot. It turns scene descriptions into conversational data, applies optional augmentation and permutation, and includes tools for evaluating chatbot responses.

## Overview

The project includes the following scripts:

- **`./scripts/extract_from_vg.py`**  
  Converts Visual Genome data into conversation-ready formats. The extractor generates five formats, depending on your training/evaluation needs. You can see the formats at the end of the ReadMe file. You can extract specific situations by ID, expand the corpus with similar ones, and generate variations using synonym/hypernym substitution. 
  
  - Key options/parameters:
  
    - `ids`: List of `(vg_id, new_id)` pairs to extract. `E.g. ids = [(1, 1), (3, 2), (4, 3), (71, 4), (9, 5)]`
    - `substitution_terms_list`: List of terms to substitute with synonyms or hypernyms from ConceptNet. You can select which terms to substitute (`e.g. term_list = ['car','jacket','shirt', 'man','woman', 'tree','road', 'bicycle']`).
    - `increase_corpus_flag`: If `True`, adds similar situations to increase data. Similarity is measured in terms of common entities.
    - `permutation_flag`: Applies word substitutions from [ConceptNet](https://conceptnet.io/) . Random substitution from a list of hypernyms and synonims. 
    - `training_and_test_sets`. Boolean. Whether to split data into train/test sets
    - `limited`, `limited_max_utterances`: Limit utterances per situation (for small data testing).
    - `test_mode`, `test_max_situations`: Extract a subset of situations for testing.
    - `write_all_files`: If `True`, saves all generated file versions
    
  -  Dependencies:
    
    - `./scripts/utils_extract_from_corpora.py`
    - `./scripts/utils_permutation_prompt.py`
    - External files:
    
      - `./data/ideallanguage.txt` (from unzipping `./data/ideallanguage.zip`)
      - `../dsc/region_graphs.json.dsc`(from running the python files in the bigger folder).

- **`./scripts/controllers.py`**  
  Simulates conversations using Botchen, based on the prompts generated by the extractor.

- **`./scripts/evaluation.py`**  
  Compares chatbot outputs with reference responses using vector-based similarity and BLEU score.

## Training procedure

- Retrieve VG data by unzipping ```./data/ideallanguage.zip``` in order to have ```./data/ideallanguage.txt```. Run the commands following the ```README``` in the parent ```vgnlp``` folder, in order to retrieve the ```../dsc/region_graphs.json.dsc``` file. 
- Build the data by running ```./script/extract_from_vg.py```, setting up the desidered parameters in ```lines 273-315``` (from ```'BEGINNING DYNAMICAL PARAMETERS WHICH THE USER CAN CHANGE'``` to ```ENDING DYNAMICAL PARAMETERS WHICH THE USER CAN CHANGE```).
- Upload the ```./data/permuted_{format}.txt``` or ```./data/augmented_{format}.txt``` file (based on your preferences and parameters) with which to train the model.
- In the Bash console, go to ```~/care-training``` and run ```flask training run chat en 128/256/512/1024/2048``` (possibility, change the iterations in ```./app/modules/chat/en/.env.trainconfig```, ```lr_decay_iters``` item).
- Upload the ```./data/prompt_{format}.txt``` file within which to automatically chat with Botchen.
- After the training is finished, automatically prompt a conversation running ```flask training chat_test module=chat language=en topk=2 content_path='./data/chat/en/prompt_{format}.txt' print_statement=True``` on the Bash console. The function I made for running the test conversatio is in ```./app/cli/controllers.py```, ```chat_test``` function. This process is saving the test conversation in ```./logs/evaluation/chat_test_topk{top_k}_format{format}.txt```

WARNING If you want to try different training sets, always remember to delete the ```./data/prompt_{format}.txt``` file from the ```./data/``` folder, since it might mess up the training.
                              
***

## Data Format Examples:

Situation data in the Visual Genome looks like:

  ```
  <situation id=1>
      <entity id=1058498>
          clock.n.01(1058498)
          green(1058498)
          tall(1058498)
      </entity>
      <entity id=5046>
          street.n.01(5046)
          sidewalk(5046)
          on(5045,5046)
      </entity>
  ```

In region_graphs.json.dsc:

  ```
  <a type=DSC idx=1382>
  <u speaker=HUM>[1058498]</u>
  <u speaker=BOT>the clock is green in colour</u>
  </a>
  <a type=DSC idx=1383>
  <u speaker=HUM>[5046, 5045]</u>
  <u speaker=BOT>shade is along the street </u>
  </a>
  ```

The extractor generates five formats, depending on your training/evaluation needs:

1. Logic to Logic 
  ```
  <script.1 type=CONV> 
  <u speaker=HUM>(clock.n green tall)</u>
  <u speaker=BOT>(street.n sidewalk shade-on)</u>
  </script.1>
  
  <script.1 type=CONV>
  <u speaker=HUM>(street.n sidewalk shade-on)</u>
  <u speaker=BOT>(shade.n on-street)</u>
  </script.1>
  ```
2. Logic to Surface
  ```
  <a script.1 type=DSC>
  <u speaker=HUM>(clock.n green tall)</u>
  <u speaker=BOT>tall green clock</u>
  </a>
  
  <a script.1 type=DSC>
  <u speaker=HUM>(shade.n on-street), (street.n sidewalk shade-on)</u>
  <u speaker=BOT>shade is along the street</u>
  </a>
  ```

3. Surface to Logic
  ```
  <a script.1 type=DSC>
  <u speaker=HUM>tall green clock</u>
  <u speaker=BOT>(clock.n green tall)</u>
  </a>
  
  <a script.1 type=DSC>
  <u speaker=HUM>shade is along the street</u>
  <u speaker=BOT>(shade.n on-street), (street.n sidewalk shade-on)</u>
  </a>
  ```

4. Surface to Surface
  ```
  <script.1 type=CONV>
  <u speaker=HUM>tall green clock</u>
  <u speaker=BOT>shade is along the street</u>
  </script.1>
  
  <script.1 type=CONV>
  <u speaker=HUM>shade is along the street</u>
  <u speaker=BOT>a man wears grey shoes</u>
  </script.1>
  ```

5. Sandwich (mixed format)
```
<a script.1 type=SDW>
<u speaker=HUM>tall green clock</u>
<u speaker=BOT>(clock.n green tall)</u>
<u speaker=BOT>(shade.n on-street), (street.n sidewalk shade-on)</u>
<u speaker=BOT>shade is along the street</u>
</a>

<a script.1 type=SDW>
<u speaker=BOT>shade is along the street</u>
<u speaker=HUM>(shade.n on-street), (street.n sidewalk shade-on)</u>
<u speaker=BOT>(gym_shoe.n grey man-wears), (man.n wears-gym_shoe)</u>
<u speaker=BOT>a man wears grey shoes</u>
</a>
```

### Prompting

The script is also outputting prompt data that can be used for evaluating the chatbot. In the format of:

1. Logic to Logic 
  ```
  <script.1 type=CONV>
  <u speaker=HUM>(man.n wears-gym_shoe)</u>
  <u speaker=HUM>(gym_shoe.n grey lover-wears)</u>
  <u speaker=HUM>(shade.n on-street)</u>
  <u speaker=HUM>(clock.n green tall)</u>
  <u speaker=HUM>(gym_shoe.n grey man-wears)</u>
  <u speaker=HUM>(shoe.n grey man-wears)</u>
  <u speaker=HUM>(lover.n wears-gym_shoe)</u>
  <u speaker=HUM>(man.n wears-shoe)</u>
  <u speaker=HUM>(street.n sidewalk shade-on)</u>
  </script.1>
  ```

2. Logic to Surface
  ```
  <a script.1 type=DSC>
  <u speaker=HUM>(shade.n on-street), (street.n sidewalk shade-on)</u>
  <u speaker=HUM>(man.n wears-gym_shoe wears-gym_shoe)</u>
  <u speaker=HUM>(gym_shoe.n grey man-wears man-wears), (man.n wears-gym_shoe wears-gym_shoe)</u>
  <u speaker=HUM>(clock.n green tall)</u>
  </a>
  ```

3. Surface to Logic
  ```
  <a script.1 type=DSC>
  <u speaker=HUM>tall green clock</u>
  <u speaker=HUM>shade is along the street</u>
  <u speaker=HUM>a man wears grey shoes</u>
  <u speaker=HUM>bicycles are seen in the bckground</u>
  <u speaker=HUM>man is wearing sneakers</u>
  </a>
  ```

4. Surface to Surface
  ```
  <script.1 type=CONV>
  <u speaker=HUM>tall green clock</u>
  <u speaker=HUM>shade is along the street</u>
  <u speaker=HUM>bicycles are seen in the bckground</u>
  <u speaker=HUM>man is wearing sneakers</u>
  <u speaker=HUM>lover is wearing sneakers</u>
  <u speaker=HUM>a man wears grey shoes</u>
  <u speaker=HUM>a lover wears grey shoes</u>
  </script.1>
  ```
5. Sandwich (mixed format)
  ```
  <a script.1 type=SDW>
  <u speaker=HUM>shade is along the street</u>
  <u speaker=HUM>a man wears grey shoes</u>
  <u speaker=HUM>bicycles are seen in the bckground</u>
  </a>
  ```
